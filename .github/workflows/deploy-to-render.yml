name: Deploy to Render

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Trigger Render deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Render deploy via API
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -euo pipefail

          if [ -z "${RENDER_API_KEY:-}" ] || [ -z "${RENDER_SERVICE_ID:-}" ]; then
            echo "RENDER_API_KEY and RENDER_SERVICE_ID must be set as repository secrets" >&2
            exit 1
          fi

          echo "Triggering deploy for service $RENDER_SERVICE_ID"
          RESP=$(curl -sS -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" -d '{}')

          echo "$RESP" | jq .

          DEPLOY_ID=$(echo "$RESP" | jq -r '.id // empty')
          if [ -z "$DEPLOY_ID" ]; then
            echo "Failed to create deploy. Response:" >&2
            echo "$RESP" >&2
            exit 1
          fi

          echo "Deploy started: $DEPLOY_ID. Polling status..."

          # Poll deploy status until finished
          for i in $(seq 1 60); do
            STATUS=$(curl -sS -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}" | jq -r '.status')
            echo "[$i] status=$STATUS"
            if [[ "$STATUS" != "build_in_progress" && "$STATUS" != "queued" && "$STATUS" != "update_in_progress" && "$STATUS" != "deploying" ]]; then
              break
            fi
            sleep 5
          done

          FINAL=$(curl -sS -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}")
          echo "$FINAL" | jq .

          STATUS=$(echo "$FINAL" | jq -r '.status')
          if [ "$STATUS" = "succeeded" ]; then
            echo "Deploy succeeded"
            exit 0
          else
            echo "Deploy finished with status: $STATUS" >&2
            exit 1
          fi
